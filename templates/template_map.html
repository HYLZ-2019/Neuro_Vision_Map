<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>The Neuromorphic Vision World - Geographic Map</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <link rel="stylesheet" type="text/css" href="../map_style.css">
</head>
<body>
    <!-- åœ°å›¾å®¹å™¨ -->
    <div id="map-container"></div>
    
    <!-- æ§åˆ¶é¢æ¿ -->
    <div id="controlPanel">
        <div class="panel-header" onclick="togglePanel()">
            <span class="panel-title">Control Panel</span>
            <div class="header-buttons">
                <button class="header-btn" id="infoBtn" onclick="showInfoModal(event)" title="View details and data sources">â„¹ï¸</button>
                <button class="header-btn" id="langBtn" onclick="toggleLanguage(event)" title="Toggle Chinese/English Display">ğŸŒ</button>
                <button class="collapse-button" id="collapseBtn">â–²</button>
            </div>
        </div>
        
        <div class="panel-content" id="panelContent">
            <div class="filter-group">
                <div class="year-header">
                    <label class="filter-label">Year Selection</label>
                    <button class="play-button" id="playButton" onclick="toggleYearPlayback()">â–¶ Play</button>
                </div>
                <div class="year-selector" id="yearSelector">
                    <!-- å¹´ä»½é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Conference Filter</label>
                <div class="conf-controls">
                    <button class="conf-control-btn" onclick="selectAllConfs()">Select All</button>
                    <button class="conf-control-btn" onclick="clearAllConfs()">Clear All</button>
                    <button class="conf-control-btn" onclick="selectTopConfs()">Main Conferences</button>
                </div>
                <div class="conf-selector">
                    <div class="conf-grid" id="confFilters">
                        <!-- ä¼šè®®é€‰é¡¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Min Collaborations</label>
                <input type="range" id="minCollabSlider" class="filter-input" min="1" max="10" value="1">
                <span id="minCollabDisplay">1</span>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">Display Options</label>
                <div class="filter-checkbox">
                    <input type="checkbox" id="showLabels">
                    <label>Show Institution Labels</label>
                </div>
                <div class="filter-checkbox">
                    <input type="checkbox" id="showCollaborations" checked>
                    <label>Show Collaborations</label>
                </div>
            </div>
        </div>
    </div>
    
    <!-- è¯¦æƒ…é¢æ¿ -->
    <div id="detailPanel">
        <div class="detail-header">
            <span class="detail-title" id="detailTitle" data-zh="æœºæ„è¯¦æƒ…" data-en="Institution Details">Institution Details</span>
            <button class="close-button" id="closeDetailButton">Ã—</button>
        </div>
        <div id="detailContent">
            <!-- è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        </div>
    </div>
    
    <!-- ä¿¡æ¯æ¨¡æ€æ¡† -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title" data-zh="è¯¦æƒ…è¯´æ˜å’Œæ•°æ®æ¥æº" data-en="Details and Data Sources">Details and Data Sources</span>
                <button class="close-button" onclick="closeInfoModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="info-section">
                    <h3 data-zh="é¡¹ç›®ç®€ä»‹" data-en="Project Overview">Project Overview</h3>
                    <p data-zh="æœ¬é¡¹ç›®å¯è§†åŒ–åœ°å±•ç°äº†ä»äº‹ç¥ç»å½¢æ€è§†è§‰ç ”ç©¶çš„æœºæ„ä¹‹é—´çš„åˆä½œå…³ç³»ã€‚" data-en="This project visualizes the collaborative relationships between institutions engaged in neuromorphic vision research.">
                        This project visualizes the collaborative relationships between institutions engaged in neuromorphic vision research.
                    </p>
                </div>
                
                <div class="info-section">
                    <h3 data-zh="æ•°æ®æ¥æº" data-en="Data Sources">æ•°æ®æ¥æºä¸è¯´æ˜</h3>
                    <p data-zh="æœ¬é¡¹ç›®ä½¿ç”¨çš„è®ºæ–‡åˆ—è¡¨æ¥æºäºäº’è”ç½‘ï¼ˆhttps://docs.google.com/spreadsheets/d/1_OBbSz10CkxXNDHQd-Mn_ui3OmymMFvm-lW316uvxy8/edit?gid=0#gid=0ï¼‰ï¼Œæˆªæ­¢æ—¥æœŸä¸º2025å¹´8æœˆ19æ—¥ã€‚åŸºäºè¯¥åˆ—è¡¨ä¸­çš„è®ºæ–‡æ ‡é¢˜ä¸ä¼šè®®/æœŸåˆŠä¿¡æ¯ï¼Œæˆ‘åŸºäºarXivä¸semantic scholarçš„APIå¯¹å®ƒä»¬çš„ä½œè€…åˆ—è¡¨ç”¨æ™ºèƒ½ä½“è¿›è¡Œäº†æŸ¥è¯¢ã€‚å¯¹äºåœ¨arXivä¸Šçš„è®ºæ–‡ï¼Œæˆ‘è®©æ™ºèƒ½ä½“å¯¹å…¶é¦–é¡µä¸Šçš„æœºæ„ä¿¡æ¯è¿›è¡Œäº†æå–ä¸æ¸…æ´—ï¼Œå¹¶æ‰‹åŠ¨å®Œæˆäº†ä¸€äº›é¢å¤–çš„æ¸…æ´—å·¥ä½œã€‚" data-en="The paper list used in this project is sourced from the internet (https://docs.google.com/spreadsheets/d/1_OBbSz10CkxXNDHQd-Mn_ui3OmymMFvm-lW316uvxy8/edit?gid=0#gid=0), with a cutoff date of August 19, 2025. Based on the paper titles and conference/journal information in the list, I used AI agents to query their author lists through arXiv and semantic scholar APIs. For papers on arXiv, I had the AI agent extract and clean the institutional information from their front pages, and manually completed some additional cleaning work.">
                        æœ¬é¡¹ç›®ä½¿ç”¨çš„è®ºæ–‡åˆ—è¡¨æ¥æºäºäº’è”ç½‘ï¼ˆhttps://docs.google.com/spreadsheets/d/1_OBbSz10CkxXNDHQd-Mn_ui3OmymMFvm-lW316uvxy8/edit?gid=0#gid=0ï¼‰ï¼Œæˆªæ­¢æ—¥æœŸä¸º2025å¹´8æœˆ19æ—¥ã€‚åŸºäºè¯¥åˆ—è¡¨ä¸­çš„è®ºæ–‡æ ‡é¢˜ä¸ä¼šè®®/æœŸåˆŠä¿¡æ¯ï¼Œæˆ‘åŸºäºarXivä¸semantic scholarçš„APIå¯¹å®ƒä»¬çš„ä½œè€…åˆ—è¡¨ç”¨æ™ºèƒ½ä½“è¿›è¡Œäº†æŸ¥è¯¢ã€‚å¯¹äºåœ¨arXivä¸Šçš„è®ºæ–‡ï¼Œæˆ‘è®©æ™ºèƒ½ä½“å¯¹å…¶é¦–é¡µä¸Šçš„æœºæ„ä¿¡æ¯è¿›è¡Œäº†æå–ä¸æ¸…æ´—ï¼Œå¹¶æ‰‹åŠ¨å®Œæˆäº†ä¸€äº›é¢å¤–çš„æ¸…æ´—å·¥ä½œã€‚
                    </p>
                    <p data-zh="ç”±äºèƒ½åŠ›æœ‰é™ï¼Œå¾ˆå¤šè®ºæ–‡çš„ä¿¡æ¯å¹¶æœªå¾—åˆ°æˆåŠŸæå–ï¼Œå¾ˆå¤šä½œè€…çš„æœºæ„ä¹Ÿæ²¡æœ‰å¾—åˆ°æ ‡æ³¨ï¼ˆæˆ‘å½’ä¸º'unknown'ï¼‰ï¼Œè¯·è§è°…ã€‚" data-en="Due to limited capabilities, information for many papers was not successfully extracted, and many authors' institutions were not annotated (I categorized them as 'unknown'). Please understand.">
                        ç”±äºèƒ½åŠ›æœ‰é™ï¼Œå¾ˆå¤šè®ºæ–‡çš„ä¿¡æ¯å¹¶æœªå¾—åˆ°æˆåŠŸæå–ï¼Œå¾ˆå¤šä½œè€…çš„æœºæ„ä¹Ÿæ²¡æœ‰å¾—åˆ°æ ‡æ³¨ï¼ˆæˆ‘å½’ä¸º"unknown"ï¼‰ï¼Œè¯·è§è°…ã€‚
                    </p>
                    <p data-zh="ç”¨äºå¯è§†åŒ–æœºæ„ä½ç½®çš„åœ°ç†åæ ‡ç”±å¤§è¯­è¨€æ¨¡å‹ç»™å‡ºã€‚ä¸ºäº†ä¾¿äºå¯è§†åŒ–ï¼Œæˆ‘ç”¨ä¸€ä¸ªç®€å•çš„ç®—æ³•æŠŠè¿‡äºå¯†é›†çš„ç‚¹æ•£å¼€ã€‚å› æ­¤ï¼Œåœ°å›¾ä¸Šçš„ä½ç½®å¹¶ä¸ç²¾ç¡®ï¼Œåªèƒ½æä¾›ä¸€ä¸ªæ„Ÿæ€§çš„è®¤è¯†ã€‚" data-en="The geographic coordinates used to visualize institutional locations are provided by large language models. To facilitate visualization, I used a simple algorithm to spread out overly dense points. Therefore, the positions on the map are not precise and can only provide an intuitive understanding.">
                        ç”¨äºå¯è§†åŒ–æœºæ„ä½ç½®çš„åœ°ç†åæ ‡ç”±å¤§è¯­è¨€æ¨¡å‹ç»™å‡ºã€‚ä¸ºäº†ä¾¿äºå¯è§†åŒ–ï¼Œæˆ‘ç”¨ä¸€ä¸ªç®€å•çš„ç®—æ³•æŠŠè¿‡äºå¯†é›†çš„ç‚¹æ•£å¼€ã€‚å› æ­¤ï¼Œåœ°å›¾ä¸Šçš„ä½ç½®å¹¶ä¸ç²¾ç¡®ï¼Œåªèƒ½æä¾›ä¸€ä¸ªæ„Ÿæ€§çš„è®¤è¯†ã€‚
                    </p>
                    <p data-zh="å¯è§†åŒ–ç½‘é¡µçš„ä»£ç ä¸»è¦ç”±åŸºäºClaude 4çš„copilotç¼–å†™ï¼Œæˆ‘æŒ‡å¯¼å®ƒè¿›è¡Œäº†è‹¥å¹²æ¬¡çš„è¿­ä»£ã€‚" data-en="The visualization webpage code was mainly written by copilot based on Claude 4, with my guidance through several iterations.">
                        å¯è§†åŒ–ç½‘é¡µçš„ä»£ç ä¸»è¦ç”±åŸºäºClaude 4çš„copilotç¼–å†™ï¼Œæˆ‘æŒ‡å¯¼å®ƒè¿›è¡Œäº†è‹¥å¹²æ¬¡çš„è¿­ä»£ã€‚
                    </p>
                    <p data-zh="æ„Ÿè°¢æ‰€æœ‰ç¥ç»å½¢æ€è§†è§‰ä»ä¸šè€…çš„ä»˜å‡ºã€‚å¸Œæœ›æˆ‘ä»¬èƒ½ä¸€åŒæºæ‰‹ï¼Œè®©è¡Œä¸šè“¬å‹ƒå‘å±•ï¼Œè®©ä¸–ç•Œè¶Šæ¥è¶Šå¥½ï¼" data-en="Thank you to all neuromorphic vision practitioners for their contributions. I hope we can work together to make the industry flourish and make the world better!">
                        æ„Ÿè°¢æ‰€æœ‰ç¥ç»å½¢æ€è§†è§‰ä»ä¸šè€…çš„ä»˜å‡ºã€‚å¸Œæœ›æˆ‘ä»¬èƒ½ä¸€åŒæºæ‰‹ï¼Œè®©è¡Œä¸šè“¬å‹ƒå‘å±•ï¼Œè®©ä¸–ç•Œè¶Šæ¥è¶Šå¥½ï¼
                    </p>
                    <p data-zh="â€”â€”HYLZ (https://github.com/HYLZ-2019)" data-en="â€”â€”HYLZ (https://github.com/HYLZ-2019)">
                        â€”â€”HYLZ (https://github.com/HYLZ-2019)
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å›¾ä¾‹ -->
    <div id="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: #ff6b6b;"></div>
            <span>Institution Location</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #888888;"></div>
            <span>Unknown Location</span>
        </div>
        <div class="legend-item">
            <div class="legend-line" style="background: linear-gradient(90deg, rgba(255,255,255,0.2), rgba(255,255,255,0.8));"></div>
            <span>Collaboration</span>
        </div>
    </div>

<script>
// åŸå§‹æ•°æ®è§£æå’Œé¢„å¤„ç†
const paper_info_list = [[INJECT_PAPER_INFO_LIST_HERE]];
// A list, each item in paper_info_list is: [title, year(2025), source(CVPR), [list of related institutes]]
    
const authors_of_institute = [[INJECT_AUTHORS_OF_INSTITUTE_HERE]];
// A dict, each key is an institute name, value is a list of authors affiliated with it

const institute_info = [[INJECT_INSTITUTE_INFO_HERE]];
// Each key is an institute name, value is an object with lat, lon, country

const research_groups = [[INJECT_RESEARCH_GROUPS_HERE]];


// å…¨å±€å˜é‡
let allPapers = [];
let availableYears = new Set();
let availableConfs = new Set();
let svg, g, projection, path;
let instituteStats = {};
let collaborationStats = {};

// ä»æ–°æ•°æ®æ ¼å¼æ„å»ºæ‰€éœ€çš„æ•°æ®ç»“æ„
let authorToInstitute = {};

// åˆå§‹åŒ–æ•°æ®
function initializeData() {
    console.log("å¼€å§‹åˆå§‹åŒ–æ•°æ®...");
    console.log("paper_info_list length:", paper_info_list.length);
    console.log("authors_of_institute:", authors_of_institute);
    console.log("institute_info:", institute_info);
    
    // æ„å»ºä½œè€…åˆ°æœºæ„çš„æ˜ å°„
    for (const [instituteName, authorList] of Object.entries(authors_of_institute)) {
        for (const author of authorList) {
            authorToInstitute[author] = instituteName;
        }
    }
    
    // å¤„ç†è®ºæ–‡æ•°æ®ï¼Œä» paper_info_list æ„å»º allPapers
    paper_info_list.forEach(paperEntry => {
        const [title, year, source, relatedInstitutes] = paperEntry;
        
        const paperObj = {
            title: title,
            year: year,
            conf: source,
            institutes: relatedInstitutes
        };
        
        allPapers.push(paperObj);
        availableYears.add(year);
        availableConfs.add(source);
    });
    
}

// é¢œè‰²ç”Ÿæˆå‡½æ•°
function getColor(str) {
    if (str === 'unknown' || str === 'Unknown') {
        return '#666666';
    }
    
    if (str.includes('Peking University')) {
        return '#c8102e';
    }
    if (str.includes('Tsinghua University')) {
        return '#4B0082';
    }

    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    
    const hue = Math.abs(hash) % 360;
    const saturation = 60 + (Math.abs(hash) % 40);
    const lightness = 50 + (Math.abs(hash) % 30);
    
    return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
}

// è·å–æœºæ„ä½ç½®
function getInstituteLocation(instituteName) {
    if (institute_info[instituteName]) {
        return institute_info[instituteName];
    }
    
    // è¿”å›é»˜è®¤ä½ç½® (ç»çº¬åº¦ä¸º0)
    return { lat: 0, lon: 0, country: "unknown" };
}

// è®¡ç®—ç»Ÿè®¡æ•°æ®
function computeStats(filteredPapers) {
    instituteStats = {};
    collaborationStats = {};
    
    // ç»Ÿè®¡æ‰€æœ‰æœºæ„ï¼ˆåŒ…æ‹¬æœªçŸ¥ä½ç½®çš„æœºæ„ï¼‰
    filteredPapers.forEach(entry => {
        const institutes = entry.institutes || []; // ä½¿ç”¨è®ºæ–‡ç›´æ¥å…³è”çš„æœºæ„åˆ—è¡¨
        const knownInstitutions = new Set();
        
        institutes.forEach(institute => {
            if (!instituteStats[institute]) {
                instituteStats[institute] = {
                    papers: 0,
                    authors: new Set(),
                    collaborations: {}
                };
            }
            
            instituteStats[institute].papers++;
            
            // æ·»åŠ è¯¥æœºæ„çš„ä½œè€…ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
            if (authors_of_institute[institute]) {
                authors_of_institute[institute].forEach(author => {
                    instituteStats[institute].authors.add(author);
                });
            }
            
            // åªæœ‰å·²çŸ¥ä½ç½®çš„æœºæ„æ‰å‚ä¸åˆä½œç»Ÿè®¡
            const location = getInstituteLocation(institute);
            if (location && !(location.lat === 0 && location.lon === 0) && location.country !== "Unknown") {
                knownInstitutions.add(institute);
            }
        });
        
        // ç»Ÿè®¡å·²çŸ¥ä½ç½®æœºæ„é—´çš„åˆä½œï¼ˆæ’é™¤æœªçŸ¥ä½ç½®æœºæ„ï¼‰
        const knownInstituteArray = Array.from(knownInstitutions);
        for (let i = 0; i < knownInstituteArray.length; i++) {
            for (let j = i + 1; j < knownInstituteArray.length; j++) {
                const inst1 = knownInstituteArray[i];
                const inst2 = knownInstituteArray[j];
                
                const pair = [inst1, inst2].sort().join('|');
                
                if (!collaborationStats[pair]) {
                    collaborationStats[pair] = 0;
                }
                collaborationStats[pair]++;
                
                if (!instituteStats[inst1].collaborations[inst2]) {
                    instituteStats[inst1].collaborations[inst2] = 0;
                }
                if (!instituteStats[inst2].collaborations[inst1]) {
                    instituteStats[inst2].collaborations[inst1] = 0;
                }
                
                instituteStats[inst1].collaborations[inst2]++;
                instituteStats[inst2].collaborations[inst1]++;
            }
        }
    });
    
    // è½¬æ¢ä½œè€…é›†åˆä¸ºæ•°é‡
    Object.keys(instituteStats).forEach(institute => {
        instituteStats[institute].authorCount = instituteStats[institute].authors.size;
    });
}

// åˆå§‹åŒ–åœ°å›¾
async function initializeMap() {
    const width = window.innerWidth;
    const height = window.innerHeight;
    
    svg = d3.select("#map-container")
        .append("svg")
        .attr("width", width)
        .attr("height", height);
    
    g = svg.append("g");
    
    // è®¾ç½®åœ°å›¾æŠ•å½± - å¢å¤§ç¼©æ”¾å€æ•°
    projection = d3.geoNaturalEarth1()
        .scale(300)  // ä»180å¢åŠ åˆ°300
        .translate([width / 2, height / 2]);
    
    path = d3.geoPath().projection(projection);
    
    // åŠ è½½ä¸–ç•Œåœ°å›¾æ•°æ®
    try {
        const world = await d3.json("https://unpkg.com/world-atlas@2/countries-110m.json");
        const countries = topojson.feature(world, world.objects.countries);
        
        // ç»˜åˆ¶å›½å®¶è¾¹ç•Œ
        g.selectAll(".country")
            .data(countries.features)
            .enter().append("path")
            .attr("class", "countries")
            .attr("d", path);
            
    } catch (error) {
        console.warn("æ— æ³•åŠ è½½ä¸–ç•Œåœ°å›¾æ•°æ®ï¼Œä½¿ç”¨ç®€åŒ–ç‰ˆæœ¬");
        // å¦‚æœæ— æ³•åŠ è½½åœ°å›¾æ•°æ®ï¼Œåˆ›å»ºä¸€ä¸ªç®€å•çš„èƒŒæ™¯
        g.append("rect")
            .attr("width", width)
            .attr("height", height)
            .attr("fill", "#2a2a2a")
            .attr("stroke", "#404040");
    }
    
    // æ·»åŠ ç¼©æ”¾å’Œæ‹–æ‹½åŠŸèƒ½ - è°ƒæ•´ç¼©æ”¾èŒƒå›´ï¼Œå¹¶åœ¨ç¼©æ”¾æ—¶ä¿æŒåœ†ç‚¹å¤§å°
    const zoom = d3.zoom()
        .scaleExtent([0.3, 10])  // å…è®¸æ›´å¤§çš„ç¼©æ”¾èŒƒå›´
        .on("zoom", (event) => {
            g.attr("transform", event.transform);
            
            // è°ƒæ•´åœ†ç‚¹å¤§å°ä»¥äºšçº¿æ€§å¢é•¿ï¼ˆç‚¹ç›¸å¯¹äºåœ°å›¾è¶Šæ¥è¶Šå°ï¼‰
            const scale = event.transform.k;
            g.selectAll(".institute-dot, .unknown-location-dot")
                .attr("r", function() {
                    const baseRadius = parseFloat(d3.select(this).attr("data-base-r"));
                    // ä½¿ç”¨å¯¹æ•°å‡½æ•°å®ç°äºšçº¿æ€§å¢é•¿ï¼šç‚¹ç›¸å¯¹äºåœ°å›¾ä¼šè¶Šæ¥è¶Šå°
                    // å½“scale=1æ—¶ï¼ŒscaleFactor=1ï¼›å½“scale=4æ—¶ï¼ŒscaleFactorçº¦ä¸º1.39ï¼›å½“scale=16æ—¶ï¼ŒscaleFactor=2
                    const scaleFactor = Math.sqrt(scale)
                    return baseRadius / scaleFactor;
                });
            
            // è°ƒæ•´è¿çº¿å®½åº¦ - äºšçº¿æ€§å¢é•¿
            g.selectAll(".collaboration-line")
                .attr("stroke-width", function() {
                    const baseWidth = parseFloat(d3.select(this).attr("data-base-width"));
                    const scaleFactor = Math.sqrt(scale);
                    return baseWidth / scaleFactor;
                });
            
            // è°ƒæ•´æ ‡ç­¾å¤§å° - äºšçº¿æ€§å¢é•¿
            g.selectAll(".institute-label, .hover-label")
                .style("font-size", function() {
                    const scaleFactor = Math.sqrt(scale);
                    return (12 / scaleFactor) + "px";
                });
            
            // è°ƒæ•´æ°´å°å¤§å° - äºšçº¿æ€§å¢é•¿
            g.selectAll(".watermark")
                .style("font-size", function() {
                    const scaleFactor = Math.sqrt(scale);
                    return (14 / scaleFactor) + "px";
                });
        });
    
    svg.call(zoom);
    
    // æ·»åŠ æ°´å° - åœ¨å¥½æœ›è§’ä¸‹æ–¹çš„æµ·åŸŸ
    const watermarkLat = -42;
    const watermarkLon = 22;
    const [watermarkX, watermarkY] = projection([watermarkLon, watermarkLat]);
    
    if (!isNaN(watermarkX) && !isNaN(watermarkY)) {
        g.append("text")
            .attr("class", "watermark")
            .attr("x", watermarkX)
            .attr("y", watermarkY)
            .text("https://github.com/HYLZ-2019/Neuro_Vision_Map")
            .style("font-size", "14px")
            .style("fill", "rgba(255, 255, 255, 0.3)")
            .style("font-family", "Arial, sans-serif")
            .style("text-anchor", "middle")
            .style("pointer-events", "none")
            .style("user-select", "none")
            .style("text-shadow", "1px 1px 2px rgba(0, 0, 0, 0.5)");
    }
}

// æ›´æ–°åœ°å›¾å¯è§†åŒ–
function updateMapVisualization() {
    const filteredPapers = getFilteredPapers();
    computeStats(filteredPapers);
    
    const minCollabThreshold = parseInt(document.getElementById('minCollabSlider').value);
    const showLabels = document.getElementById('showLabels').checked;
    const showCollaborations = document.getElementById('showCollaborations').checked;
    
    // åˆ†ç¦»å·²çŸ¥ä½ç½®å’ŒæœªçŸ¥ä½ç½®çš„æœºæ„
    const knownInstitutes = [];
    const unknownInstitutes = [];
    
    Object.keys(instituteStats).forEach(institute => {
        const location = getInstituteLocation(institute);
        const stats = instituteStats[institute];
        
        if (!location || (location.lat === 0 && location.lon === 0) || location.country === "unknown") {
            // æœªçŸ¥ä½ç½®çš„æœºæ„
            unknownInstitutes.push({
                name: institute,
                papers: stats.papers,
                authors: stats.authorCount,
                location: location
            });
        } else {
            // å·²çŸ¥ä½ç½®çš„æœºæ„
            const [x, y] = projection([location.lon, location.lat]);
            knownInstitutes.push({
                name: institute,
                x: x,
                y: y,
                papers: stats.papers,
                authors: stats.authorCount,
                location: location
            });
        }
    });
    
    // è¿‡æ»¤æ‰æ— æ•ˆåæ ‡çš„å·²çŸ¥æœºæ„
    const validKnownInstitutes = knownInstitutes.filter(d => !isNaN(d.x) && !isNaN(d.y));
    
    // è°ƒæ•´é‡å ä½ç½®
    adjustOverlappingPositions(validKnownInstitutes);
    
    // è®¡ç®—åˆä½œè¿çº¿æ•°æ®ï¼ˆåªåŒ…å«å·²çŸ¥ä½ç½®æœºæ„é—´çš„åˆä½œï¼‰
    const collaborations = Object.entries(collaborationStats)
        .filter(([pair, count]) => count >= minCollabThreshold)
        .map(([pair, count]) => {
            const [inst1, inst2] = pair.split('|');
            
            // ä»è°ƒæ•´åçš„institutesæ•°ç»„ä¸­æ‰¾åˆ°å¯¹åº”çš„ä½ç½®
            const institute1 = validKnownInstitutes.find(inst => inst.name === inst1);
            const institute2 = validKnownInstitutes.find(inst => inst.name === inst2);
            
            if (!institute1 || !institute2) {
                return null;
            }
            
            return {
                source: {name: inst1, x: institute1.x, y: institute1.y},
                target: {name: inst2, x: institute2.x, y: institute2.y},
                count: count
            };
        })
        .filter(d => d !== null);
    
    // ç§»é™¤æ—§çš„å¯è§†åŒ–å…ƒç´ 
    g.selectAll(".collaboration-line").remove();
    g.selectAll(".institute-dot").remove();
    g.selectAll(".institute-label").remove();
    g.selectAll(".unknown-location-dot").remove();
    
    // ç»˜åˆ¶åˆä½œè¿çº¿
    if (showCollaborations) {
        const maxCollabCount = d3.max(collaborations, d => d.count) || 1;
        
        g.selectAll(".collaboration-line")
            .data(collaborations)
            .enter().append("line")
            .attr("class", "collaboration-line")
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y)
            .attr("stroke", "#ffffff")
            .attr("stroke-width", d => Math.sqrt(d.count / maxCollabCount) * 1.5 + 0.3)
            .attr("stroke-opacity", d => 0.05 + (d.count / maxCollabCount) * 0.1)
            .attr("data-source", d => d.source.name)
            .attr("data-target", d => d.target.name)
            .attr("data-base-width", d => Math.sqrt(d.count / maxCollabCount) * 1.5 + 0.3)
            .attr("vector-effect", "non-scaling-stroke")
            .datum(d => d);
    }
    
    // ç»˜åˆ¶å·²çŸ¥ä½ç½®çš„æœºæ„åœ†ç‚¹
    const maxPapers = d3.max(validKnownInstitutes, d => d.papers) || 1;
    
    const dots = g.selectAll(".institute-dot")
        .data(validKnownInstitutes)
        .enter().append("circle")
        .attr("class", "institute-dot")
        .attr("cx", d => d.x)
        .attr("cy", d => d.y)
        .attr("r", d => {
            const radius = Math.sqrt(d.papers / maxPapers) * 6 + 2;
            return radius;
        })
        .attr("data-base-r", d => Math.sqrt(d.papers / maxPapers) * 6 + 2)
        .attr("fill", d => getColor(d.name))
        .attr("vector-effect", "non-scaling-stroke")
        .on("click", function(event, d) {
            g.selectAll(".institute-dot, .unknown-location-dot").classed("clicked", false);
            d3.select(this).classed("clicked", true);
            
            showInstituteDetails(d);
            highlightCollaborations(d.name);
        })
        .on("mouseover", function(event, d) {
            highlightCollaborations(d.name);
            showInstituteLabel(d);
        })
        .on("mouseout", function(event, d) {
            resetHighlight();
            hideInstituteLabel();
        });
    
    // ç»˜åˆ¶æœªçŸ¥ä½ç½®çš„æ±‡æ€»ç‚¹ï¼ˆåœ¨åœ°å›¾å·¦ä¸‹æ–¹ï¼‰
    if (unknownInstitutes.length > 0) {
        // è·å–åœ°å›¾è§†çª—å°ºå¯¸ï¼Œå°†unknownç‚¹æ”¾åœ¨å·¦ä¸‹è§’
        const mapWidth = svg.attr("width");
        const mapHeight = svg.attr("height");
        const unknownX = 50; // è·ç¦»å·¦è¾¹ç•Œ50åƒç´ 
        const unknownY = mapHeight - 50; // è·ç¦»åº•è¾¹ç•Œ50åƒç´ 
        const unknownRadius = 12; // å›ºå®šå¤§å°
        const totalUnknownPapers = unknownInstitutes.reduce((sum, inst) => sum + inst.papers, 0);
        
        g.append("circle")
            .attr("class", "unknown-location-dot")
            .attr("cx", unknownX)
            .attr("cy", unknownY)
            .attr("r", unknownRadius)
            .attr("data-base-r", unknownRadius)
            .attr("fill", "#888888")
            .attr("stroke", "#ffffff")
            .attr("stroke-width", 2)
            .attr("vector-effect", "non-scaling-stroke")
            .style("cursor", "pointer")
            .on("click", function(event) {
                g.selectAll(".institute-dot, .unknown-location-dot").classed("clicked", false);
                d3.select(this).classed("clicked", true);
                
                showUnknownLocationDetails(unknownInstitutes);
            })
            .on("mouseover", function(event) {
                showUnknownLocationLabel(unknownInstitutes.length, totalUnknownPapers, unknownX, unknownY);
            })
            .on("mouseout", function(event) {
                hideInstituteLabel();
            });
    }
    
    // å­˜å‚¨åœ†ç‚¹å¼•ç”¨ä»¥ä¾¿åœ¨ç¼©æ”¾æ—¶è°ƒæ•´å¤§å°
    g.property("instituteDots", dots);
    
    // ç»˜åˆ¶æœºæ„æ ‡ç­¾ï¼ˆåªæ˜¾ç¤ºå·²çŸ¥ä½ç½®çš„æœºæ„ï¼‰
    if (showLabels) {
        g.selectAll(".institute-label")
            .data(validKnownInstitutes.filter(d => d.papers > 1))
            .enter().append("text")
            .attr("class", "institute-label")
            .attr("x", d => d.x + 12)
            .attr("y", d => d.y + 4)
            .style("font-size", "12px")
            .text(d => {
                const name = d.name.replace(/ğŸ‡¨ğŸ‡³|ğŸ‡ºğŸ‡¸|ğŸ‡¬ğŸ‡§|ğŸ‡©ğŸ‡ª|ğŸ‡¯ğŸ‡µ|ğŸ‡°ğŸ‡·|ğŸ‡¸ğŸ‡¬|ğŸ‡­ğŸ‡°|ğŸ‡¦ğŸ‡º|ğŸ‡¨ğŸ‡¦|ğŸ‡«ğŸ‡®|ğŸ‡§ğŸ‡ª|ğŸ‡³ğŸ‡±|ğŸ‡«ğŸ‡·|ğŸ‡¨ğŸ‡­|ğŸ‡®ğŸ‡¹|ğŸ‡ªğŸ‡¸|ğŸ‡¸ğŸ‡ª|ğŸ‡©ğŸ‡°|ğŸ‡µğŸ‡±|ğŸ‡µğŸ‡¹|ğŸ‡®ğŸ‡³|ğŸ‡¸ğŸ‡¦|ğŸ‡¦ğŸ‡ª|ğŸ‡¨ğŸ‡¾|ğŸ‡¨ğŸ‡±|ğŸ‡ªğŸ‡º/g, '').trim();
                return name.length > 25 ? name.substring(0, 22) + '...' : name;
            });
    }
}

// é«˜äº®ä¸æŒ‡å®šæœºæ„ç›¸å…³çš„è¿çº¿
function highlightCollaborations(instituteName) {
    g.selectAll(".collaboration-line")
        .attr("stroke-opacity", function() {
            const source = d3.select(this).attr("data-source");
            const target = d3.select(this).attr("data-target");
            if (source === instituteName || target === instituteName) {
                return 1.0; // é«˜äº®çš„è¿çº¿è®¾ç½®ä¸º100%é€æ˜åº¦
            }
            return 0.005; // å…¶ä»–è¿çº¿å˜å¾—éå¸¸æ·¡
        })
        .attr("stroke-width", function() {
            const source = d3.select(this).attr("data-source");
            const target = d3.select(this).attr("data-target");
            const currentWidth = parseFloat(d3.select(this).attr("data-base-width"));
            if (source === instituteName || target === instituteName) {
                return currentWidth * 2; // é«˜äº®è¿çº¿å¢å¤§ç²—ç»†åˆ°2å€
            }
            return currentWidth * 0.5; // å…¶ä»–è¿çº¿å˜ç»†
        });
}

// é‡ç½®é«˜äº®çŠ¶æ€
function resetHighlight() {
    // åªè€ƒè™‘å·²çŸ¥ä½ç½®æœºæ„é—´çš„åˆä½œå…³ç³»
    const validCollaborations = Object.entries(collaborationStats)
        .filter(([pair, count]) => {
            const [inst1, inst2] = pair.split('|');
            const location1 = getInstituteLocation(inst1);
            const location2 = getInstituteLocation(inst2);
            
            // æ’é™¤æœªçŸ¥ä½ç½®çš„æœºæ„
            const isInst1Unknown = !location1 || (location1.lat === 0 && location1.lon === 0) || location1.country === "unknown";
            const isInst2Unknown = !location2 || (location2.lat === 0 && location2.lon === 0) || location2.country === "unknown";
            
            return !isInst1Unknown && !isInst2Unknown && count >= parseInt(document.getElementById('minCollabSlider').value);
        });
    
    const maxCollabCount = d3.max(validCollaborations, ([pair, count]) => count) || 1;
    
    g.selectAll(".collaboration-line")
        .attr("stroke-opacity", function() {
            const data = d3.select(this).datum();
            return 0.05 + (data.count / maxCollabCount) * 0.1; // æ¢å¤åŸå§‹é€æ˜åº¦
        })
        .attr("stroke-width", function() {
            const data = d3.select(this).datum();
            return Math.sqrt(data.count / maxCollabCount) * 1.5 + 0.3; // æ¢å¤åŸå§‹ç²—ç»†
        });
}

// æ˜¾ç¤ºæ‚¬æµ®æ—¶çš„æœºæ„æ ‡ç­¾
function showInstituteLabel(institute) {
    if (!document.getElementById('showLabels').checked) {
        // ç§»é™¤ç°æœ‰çš„æ‚¬æµ®æ ‡ç­¾
        g.selectAll(".hover-label").remove();
        
        // è·å–å½“å‰ç¼©æ”¾æ¯”ä¾‹
        const currentTransform = d3.zoomTransform(svg.node());
        const scale = currentTransform.k;
        const scaleFactor = Math.sqrt(scale);
        
        // æ·»åŠ æ‚¬æµ®æ ‡ç­¾
        const name = institute.name.replace(/ğŸ‡¨ğŸ‡³|ğŸ‡ºğŸ‡¸|ğŸ‡¬ğŸ‡§|ğŸ‡©ğŸ‡ª|ğŸ‡¯ğŸ‡µ|ğŸ‡°ğŸ‡·|ğŸ‡¸ğŸ‡¬|ğŸ‡­ğŸ‡°|ğŸ‡¦ğŸ‡º|ğŸ‡¨ğŸ‡¦|ğŸ‡«ğŸ‡®|ğŸ‡§ğŸ‡ª|ğŸ‡³ğŸ‡±|ğŸ‡«ğŸ‡·|ğŸ‡¨ğŸ‡­|ğŸ‡®ğŸ‡¹|ğŸ‡ªğŸ‡¸|ğŸ‡¸ğŸ‡ª|ğŸ‡©ğŸ‡°|ğŸ‡µğŸ‡±|ğŸ‡µğŸ‡¹|ğŸ‡®ğŸ‡³|ğŸ‡¸ğŸ‡¦|ğŸ‡¦ğŸ‡ª|ğŸ‡¨ğŸ‡¾|ğŸ‡¨ğŸ‡±|ğŸ‡ªğŸ‡º/g, '').trim();
        const displayName = name.length > 25 ? name.substring(0, 22) + '...' : name;
        
        g.append("text")
            .attr("class", "hover-label")
            .attr("x", institute.x + 12)
            .attr("y", institute.y + 4)
            .text(displayName)
            .style("pointer-events", "none")
            .style("font-size", (12 / scaleFactor) + "px")  // äºšçº¿æ€§ç¼©æ”¾
            .style("fill", "white")
            .style("text-shadow", "1px 1px 2px rgba(0,0,0,0.8)")
            .style("font-weight", "500");
    }
}

// éšè—æ‚¬æµ®æ ‡ç­¾
function hideInstituteLabel() {
    g.selectAll(".hover-label").remove();
}

// è°ƒæ•´é‡å ä½ç½®çš„å‡½æ•° - åŸºäºç‰©ç†æ¨¡æ‹Ÿçš„è¿­ä»£ç®—æ³•
function adjustOverlappingPositions(institutes) {

    if (institutes.length <= 1) return;
    
    const minDistance = 5; // æœ€å°è·ç¦»
    const maxIterations = 100; // æœ€å¤§è¿­ä»£æ¬¡æ•°
    const convergenceThreshold = 0.1; // æ”¶æ•›é˜ˆå€¼
    const damping = 0.8; // é˜»å°¼ç³»æ•°ï¼Œé˜²æ­¢éœ‡è¡
    
    // è®°å½•æ¯ä¸ªç‚¹çš„åŸå§‹ä½ç½®
    const originalPositions = institutes.map(inst => ({
        x: inst.x,
        y: inst.y,
        name: inst.name
    }));
    
    // åˆå§‹åŒ–é€Ÿåº¦
	const velocities = institutes.map(() => ({ 
		vx: (Math.random() - 0.5) * 0.05, 
		vy: (Math.random() - 0.5) * 0.05 
	}));
    
    for (let iteration = 0; iteration < maxIterations; iteration++) {
        let totalMovement = 0;
        
        // è®¡ç®—æ¯ä¸ªç‚¹å—åˆ°çš„åˆåŠ›
        const forces = institutes.map((institute, i) => {
            let fx = 0, fy = 0;
            
            // 1. ä¸åŸå§‹ä½ç½®çš„å¸å¼•åŠ›ï¼ˆå›å½’åŸä½çš„è¶‹åŠ¿ï¼‰
            const attractionStrength = 0.1; // å¸å¼•åŠ›å¼ºåº¦
            const originalPos = originalPositions[i];
            const dx_orig = originalPos.x - institute.x;
            const dy_orig = originalPos.y - institute.y;
            const dist_orig = Math.sqrt(dx_orig * dx_orig + dy_orig * dy_orig);
            
            if (dist_orig > 0) {
                fx += attractionStrength * dx_orig;
                fy += attractionStrength * dy_orig;
            }
            
            // 2. ä¸å…¶ä»–ç‚¹çš„æ’æ–¥åŠ›
            for (let j = 0; j < institutes.length; j++) {
                if (i === j) continue;
                
                const other = institutes[j];
                const dx = institute.x - other.x;
                const dy = institute.y - other.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < minDistance && distance > 0) {
                    // æ–¥åŠ›å¼ºåº¦ä¸è·ç¦»æˆåæ¯”ï¼Œè·ç¦»è¶Šè¿‘æ–¥åŠ›è¶Šå¼º
                    const repulsionStrength = Math.pow(minDistance / distance, 2) * 2;
                    const unitDx = dx / distance;
                    const unitDy = dy / distance;
                    
                    fx += repulsionStrength * unitDx;
                    fy += repulsionStrength * unitDy;
                }
            }
            
            return { fx, fy };
        });
        
        // æ›´æ–°ä½ç½®å’Œé€Ÿåº¦
        for (let i = 0; i < institutes.length; i++) {
            const force = forces[i];
            const velocity = velocities[i];
            
            // æ›´æ–°é€Ÿåº¦ï¼ˆåŠ å…¥é˜»å°¼ï¼‰
            velocity.vx = (velocity.vx + force.fx) * damping;
            velocity.vy = (velocity.vy + force.fy) * damping;
            
            // é™åˆ¶æœ€å¤§é€Ÿåº¦ï¼Œé˜²æ­¢ç§»åŠ¨è¿‡å¿«
            const maxVelocity = 2;
            const speed = Math.sqrt(velocity.vx * velocity.vx + velocity.vy * velocity.vy);
            if (speed > maxVelocity) {
                velocity.vx = (velocity.vx / speed) * maxVelocity;
                velocity.vy = (velocity.vy / speed) * maxVelocity;
            }
            
            // æ›´æ–°ä½ç½®
            const oldX = institutes[i].x;
            const oldY = institutes[i].y;
            institutes[i].x += velocity.vx;
            institutes[i].y += velocity.vy;
            
            // ç´¯è®¡ç§»åŠ¨è·ç¦»ï¼Œç”¨äºåˆ¤æ–­æ”¶æ•›
            const movement = Math.sqrt(
                Math.pow(institutes[i].x - oldX, 2) + 
                Math.pow(institutes[i].y - oldY, 2)
            );
            totalMovement += movement;
        }
        
        // æ£€æŸ¥æ˜¯å¦æ”¶æ•›
        const avgMovement = totalMovement / institutes.length;
        if (avgMovement < convergenceThreshold) {
            console.log(`ä½ç½®è°ƒæ•´åœ¨ç¬¬ ${iteration + 1} æ¬¡è¿­ä»£åæ”¶æ•›`);
            break;
        }
    }
    
    console.log(`ä½ç½®è°ƒæ•´å®Œæˆï¼Œå¤„ç†äº† ${institutes.length} ä¸ªæœºæ„`);
}

// è·å–ç­›é€‰åçš„è®ºæ–‡
function getFilteredPapers() {
    const selectedYears = getSelectedYears();
    const selectedConfs = Array.from(document.querySelectorAll('#confFilters input:checked'))
        .map(input => input.value);
    
    console.log("é€‰æ‹©çš„å¹´ä»½:", selectedYears);
    console.log("é€‰æ‹©çš„ä¼šè®®:", selectedConfs);
    console.log("æ€»è®ºæ–‡æ•°:", allPapers.length);
    
    if (selectedYears.length === 0) {
        console.warn("æ²¡æœ‰é€‰æ‹©ä»»ä½•å¹´ä»½ï¼");
        return [];
    }
    
    if (selectedConfs.length === 0) {
        console.warn("æ²¡æœ‰é€‰æ‹©ä»»ä½•ä¼šè®®ï¼");
        return [];
    }
    
    const filtered = allPapers.filter(paper => {
        const yearMatch = selectedYears.includes(paper.year);
        const confMatch = selectedConfs.includes(paper.conf);        
        return yearMatch && confMatch;
    });
    
    console.log("ç­›é€‰åè®ºæ–‡æ•°:", filtered.length);
    return filtered;
}

// åˆ‡æ¢ç« èŠ‚æ˜¾ç¤º/éšè—
function toggleSection(sectionId) {
    const section = document.getElementById(sectionId);
    const button = event.target;
    
    if (section.style.display === 'none' || section.style.display === '') {
        section.style.display = 'block';
        button.textContent = currentLanguage === 'zh' ? 'éšè—' : 'Hide';
    } else {
        section.style.display = 'none';
        button.textContent = currentLanguage === 'zh' ? 'æ˜¾ç¤º' : 'Show';
    }
}

// æ˜¾ç¤ºæœºæ„è¯¦æƒ…
function showInstituteDetails(institute) {
    const panel = document.getElementById('detailPanel');
    const title = document.getElementById('detailTitle');
    const content = document.getElementById('detailContent');
    
    title.textContent = institute.name;
    
    // åœ¨titleå…ƒç´ ä¸Šä¿å­˜åŸå§‹æœºæ„åç§°ï¼Œç”¨äºè¯­è¨€åˆ‡æ¢æ—¶çš„è¯†åˆ«
    title.setAttribute('data-original-name', institute.name);
    title.removeAttribute('data-unknown-locations');
    
    const collabList = Object.entries(instituteStats[institute.name].collaborations)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

    const labels = currentLanguage === 'zh' ? 
        {
            papers: 'è®ºæ–‡æ•°é‡:',
            authors: 'ä½œè€…æ•°é‡:',
            location: 'åœ°ç†ä½ç½®:',
            city: 'åŸå¸‚:',
            focus: 'ç ”ç©¶æ–¹å‘:',
            purpose: 'æœºæ„æ€§è´¨:',
            website: 'ç½‘ç«™:',
            collaborations: 'ä¸»è¦åˆä½œæœºæ„:',
            collabCount: 'æ¬¡åˆä½œ'
        } : 
        {
            papers: 'Papers:',
            authors: 'Authors:',
            location: 'Location:',
            city: 'City:',
            focus: 'Research Focus:',
            purpose: 'Purpose:',
            website: 'Website:',
            collaborations: 'Main Collaborations:',
            collabCount: 'collaborations'
        };
    
    // è·å–æœºæ„çš„è¯¦ç»†ä¿¡æ¯
    const locationInfo = institute.location;
    
    let contentHtml = `
        <div class="stat-item">
            <span class="stat-label">${labels.papers}</span>
            <span class="stat-value">${institute.papers}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">${labels.authors}</span>
            <span class="stat-value">${institute.authors}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">${labels.location}</span>
            <span class="stat-value">${locationInfo.country}</span>
        </div>`;
    
    // æ·»åŠ åŸå¸‚ä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (locationInfo.city) {
        contentHtml += `
        <div class="stat-item">
            <span class="stat-label">${labels.city}</span>
            <span class="stat-value">${locationInfo.city}</span>
        </div>`;
    }
    
    // æ·»åŠ æœºæ„æ€§è´¨ä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (locationInfo.purpose) {
        contentHtml += `
        <div class="stat-item">
            <span class="stat-label">${labels.purpose}</span>
            <span class="stat-value">${locationInfo.purpose}</span>
        </div>`;
    }
    
    // æ·»åŠ ç½‘ç«™é“¾æ¥ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (locationInfo.url) {
        contentHtml += `
        <div class="stat-item">
            <span class="stat-label">${labels.website}</span>
            <span class="stat-value"><a href="${locationInfo.url}" target="_blank" style="color: #64b5f6; text-decoration: none;">${locationInfo.url}</a></span>
        </div>`;
    }
    
    // æ·»åŠ ç ”ç©¶æ–¹å‘ä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (locationInfo.focus) {
        contentHtml += `
        <div class="stat-item">
            <span class="stat-label">${labels.focus}</span>
            <span class="stat-value" style="font-size: 10px; line-height: 1.3;">${locationInfo.focus}</span>
        </div>`;
    }
    
    // æ·»åŠ æœºæ„logoï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (locationInfo.image_url) {
        contentHtml += `
        <div class="stat-item" style="text-align: center; margin: 10px 0;">
            <img src="${locationInfo.image_url}" alt="Institution Logo" style="max-width: 100%; max-height: 60px; object-fit: contain;">
        </div>`;
    }
    
    // è·å–è¯¥æœºæ„çš„research groups
    const instituteGroups = research_groups.filter(group => group.institute === institute.name);
    
    // æ·»åŠ research groupsä¿¡æ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (instituteGroups.length > 0) {
        const groupsLabel = currentLanguage === 'zh' ? 'ç ”ç©¶è¯¾é¢˜ç»„:' : 'Research Groups:';
        contentHtml += `
        <div class="stat-item">
            <span class="stat-label">${groupsLabel}</span>
        </div>`;
        
        instituteGroups.forEach(group => {
            let groupHtml = '<div style="margin-left: 10px; font-size: 11px; color: #ccc; margin-bottom: 8px;">';
            
            // æ˜¾ç¤ºè¯¾é¢˜ç»„åç§°ï¼ˆå¦‚æœå­˜åœ¨ä¸”ä¸ä¸ºç©ºï¼‰
            if (group.group_name && group.group_name.trim() !== '') {
                groupHtml += `<div style="font-weight: bold; color: #fff;">${group.group_name}</div>`;
            }
            
            // æ˜¾ç¤ºè¯¾é¢˜ç»„ç½‘å€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (group.url) {
                groupHtml += `<div><a href="${group.url}" target="_blank" style="color: #64b5f6; text-decoration: none;">${group.url}</a></div>`;
            }
            
            // æ˜¾ç¤ºç ”ç©¶æ–¹å‘ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (group.focus) {
                const focusLabel = currentLanguage === 'zh' ? 'ç ”ç©¶æ–¹å‘: ' : 'Focus: ';
                groupHtml += `<div style="font-size: 10px; margin-top: 2px;">${focusLabel}${group.focus}</div>`;
            }
            
            // æ˜¾ç¤ºè¯¾é¢˜ç»„logoï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (group.image_url) {
                groupHtml += `<div style="margin-top: 4px;"><img src="${group.image_url}" alt="Group Logo" style="max-width: 80px; max-height: 30px; object-fit: contain;"></div>`;
            }
            
            groupHtml += '</div>';
            contentHtml += groupHtml;
        });
    }
    
    // æ·»åŠ åˆä½œæœºæ„ä¿¡æ¯
    contentHtml += `
        <div class="stat-item">
            <span class="stat-label">${labels.collaborations}</span>
        </div>
        ${collabList.map(([inst, count]) => `
            <div style="margin-left: 10px; font-size: 11px; color: #ccc;">
                ${inst}: ${count} ${labels.collabCount}
            </div>
        `).join('')}
    `;
    
    // è·å–è¯¥æœºæ„çš„è®ºæ–‡åˆ—è¡¨
    const institutePapers = paper_info_list.filter(paper => 
        paper.institutes && paper.institutes.includes(institute.name)
    );
    
    // è·å–è¯¥æœºæ„çš„ä½œè€…åˆ—è¡¨
    const instituteAuthors = authors_of_institute[institute.name] || [];
    
    // æ·»åŠ è®ºæ–‡åˆ—è¡¨ï¼ˆå¯æŠ˜å ï¼‰
    if (institutePapers.length > 0) {
        const papersLabel = currentLanguage === 'zh' ? 'è®ºæ–‡åˆ—è¡¨' : 'Papers List';
        const showLabel = currentLanguage === 'zh' ? 'æ˜¾ç¤º' : 'Show';
        const hideLabel = currentLanguage === 'zh' ? 'éšè—' : 'Hide';
        
        contentHtml += `
        <div class="stat-item" style="margin-top: 15px;">
            <span class="stat-label">${papersLabel} (${institutePapers.length})</span>
            <button onclick="toggleSection('papers-${institute.name.replace(/[^a-zA-Z0-9]/g, '')}')" 
                    style="margin-left: 10px; padding: 2px 8px; font-size: 10px; background: #555; color: white; border: none; border-radius: 3px; cursor: pointer;">
                ${showLabel}
            </button>
        </div>
        <div id="papers-${institute.name.replace(/[^a-zA-Z0-9]/g, '')}" style="display: none; max-height: 200px; overflow-y: auto; margin: 5px 0; padding: 5px; background: #2a2a2a; border-radius: 3px;">
            ${institutePapers.map((paper, index) => `
                <div style="font-size: 10px; color: #ccc; margin-bottom: 8px; padding: 5px; background: #333; border-radius: 2px;">
                    <div style="font-weight: bold; color: #fff; margin-bottom: 2px;">${index + 1}. ${paper.title}</div>
                    <div style="color: #aaa;">Year: ${paper.year} | Conference: ${paper.conf}</div>
                    ${paper.authors ? `<div style="color: #999; margin-top: 2px;">Authors: ${paper.authors.join(', ')}</div>` : ''}
                </div>
            `).join('')}
        </div>
        `;
    }
    
    // æ·»åŠ ä½œè€…åˆ—è¡¨ï¼ˆå¯æŠ˜å ï¼‰
    if (instituteAuthors.length > 0) {
        const authorsLabel = currentLanguage === 'zh' ? 'ä½œè€…åˆ—è¡¨' : 'Authors List';
        const showLabel = currentLanguage === 'zh' ? 'æ˜¾ç¤º' : 'Show';
        
        contentHtml += `
        <div class="stat-item" style="margin-top: 15px;">
            <span class="stat-label">${authorsLabel} (${instituteAuthors.length})</span>
            <button onclick="toggleSection('authors-${institute.name.replace(/[^a-zA-Z0-9]/g, '')}')" 
                    style="margin-left: 10px; padding: 2px 8px; font-size: 10px; background: #555; color: white; border: none; border-radius: 3px; cursor: pointer;">
                ${showLabel}
            </button>
        </div>
        <div id="authors-${institute.name.replace(/[^a-zA-Z0-9]/g, '')}" style="display: none; max-height: 200px; overflow-y: auto; margin: 5px 0; padding: 5px; background: #2a2a2a; border-radius: 3px;">
            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                ${instituteAuthors.map(author => `
                    <span style="font-size: 10px; color: #fff; background: #444; padding: 3px 6px; border-radius: 10px;">${author}</span>
                `).join('')}
            </div>
        </div>
        `;
    }
    
    content.innerHTML = contentHtml;
    
    panel.style.display = 'block';
}

// æ˜¾ç¤ºæœªçŸ¥ä½ç½®æœºæ„çš„è¯¦æƒ…
function showUnknownLocationDetails(unknownInstitutes) {
    const panel = document.getElementById('detailPanel');
    const title = document.getElementById('detailTitle');
    const content = document.getElementById('detailContent');
    
    const titleText = currentLanguage === 'zh' ? 'æœªçŸ¥ä½ç½®æœºæ„' : 'Unknown Locations';
    title.textContent = titleText;
    
    // è®¾ç½®æ ‡è¯†ï¼Œç”¨äºè¯­è¨€åˆ‡æ¢æ—¶è¯†åˆ«
    title.setAttribute('data-unknown-locations', 'true');
    title.removeAttribute('data-original-name');
    
    const totalPapers = unknownInstitutes.reduce((sum, inst) => sum + inst.papers, 0);
    const totalAuthors = unknownInstitutes.reduce((sum, inst) => sum + inst.authors, 0);
    
    // æŒ‰è®ºæ–‡æ•°é‡æ’åº
    const sortedInstitutes = unknownInstitutes.sort((a, b) => b.papers - a.papers);

    const labels = currentLanguage === 'zh' ? 
        {
            totalInstitutes: 'æœºæ„æ€»æ•°:',
            totalPapers: 'è®ºæ–‡æ€»æ•°:',
            totalAuthors: 'ä½œè€…æ€»æ•°:',
            instituteList: 'æœºæ„åˆ—è¡¨:',
            papers: 'è®ºæ–‡',
            authors: 'ä½œè€…'
        } : 
        {
            totalInstitutes: 'Total Institutions:',
            totalPapers: 'Total Papers:',
            totalAuthors: 'Total Authors:',
            instituteList: 'Institution List:',
            papers: 'Papers',
            authors: 'Authors'
        };
    
    content.innerHTML = `
        <div class="stat-item">
            <span class="stat-label">${labels.totalInstitutes}</span>
            <span class="stat-value">${unknownInstitutes.length}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">${labels.totalPapers}</span>
            <span class="stat-value">${totalPapers}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">${labels.totalAuthors}</span>
            <span class="stat-value">${totalAuthors}</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">${labels.instituteList}</span>
        </div>
        <div style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
            ${sortedInstitutes.map(inst => `
                <div style="margin-left: 10px; font-size: 11px; color: #ccc; margin-bottom: 5px; padding: 3px; border-left: 2px solid #666;">
                    <div style="font-weight: bold;">${inst.name}</div>
                    <div>${labels.papers}: ${inst.papers} | ${labels.authors}: ${inst.authors}</div>
                </div>
            `).join('')}
        </div>
    `;
    
    panel.style.display = 'block';
}

// æ˜¾ç¤ºæœªçŸ¥ä½ç½®ç‚¹çš„æ‚¬æµ®æ ‡ç­¾
function showUnknownLocationLabel(instituteCount, totalPapers, x, y) {
    if (!document.getElementById('showLabels').checked) {
        // ç§»é™¤ç°æœ‰çš„æ‚¬æµ®æ ‡ç­¾
        g.selectAll(".hover-label").remove();
        
        // è·å–å½“å‰ç¼©æ”¾æ¯”ä¾‹
        const currentTransform = d3.zoomTransform(svg.node());
        const scale = currentTransform.k;
        const scaleFactor = Math.sqrt(scale);
        
        // æ·»åŠ æ‚¬æµ®æ ‡ç­¾
        g.append("text")
            .attr("class", "hover-label")
            .attr("x", x + 15)
            .attr("y", y - 5)
            .text(`Unknown Locations (${instituteCount} institutes, ${totalPapers} papers)`)
            .style("pointer-events", "none")
            .style("font-size", (12 / scaleFactor) + "px")
            .style("fill", "white")
            .style("text-shadow", "1px 1px 2px rgba(0,0,0,0.8)")
            .style("font-weight", "500");
    }
}

// é¢æ¿æŠ˜å æ§åˆ¶
function togglePanel() {
    const panel = document.getElementById('controlPanel');
    const btn = document.getElementById('collapseBtn');
    
    panel.classList.toggle('collapsed');
    btn.textContent = panel.classList.contains('collapsed') ? 'â–¼' : 'â–²';
}

// å¹´ä»½é€‰æ‹©å™¨ç›¸å…³å‡½æ•°
function createYearSelector() {
    const yearSelector = document.getElementById('yearSelector');
    const currentYear = new Date().getFullYear();
    
    console.log("Available years from data:", Array.from(availableYears));
    
    // ç”Ÿæˆ2015-2025å¹´çš„é€‰é¡¹
    for (let year = 2015; year <= 2025; year++) {
        const yearStr = year.toString(); // ç¡®ä¿åŒ¹é…å­—ç¬¦ä¸²æ ¼å¼
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `year-${yearStr}`;
        checkbox.checked = true; // é»˜è®¤å…¨é€‰
        checkbox.addEventListener('change', updateMapVisualization);
        
        const label = document.createElement('label');
        label.htmlFor = `year-${yearStr}`;
        label.textContent = yearStr;
        
        const wrapper = document.createElement('div');
        wrapper.className = 'year-option';
        wrapper.appendChild(checkbox);
        wrapper.appendChild(label);
        
        yearSelector.appendChild(wrapper);
    }
    
    console.log("Year selector created with", yearSelector.children.length, "options");
}

function getSelectedYears() {
    const years = [];
    for (let year = 2015; year <= 2025; year++) {
        const yearStr = year.toString(); // ç¡®ä¿å­—ç¬¦ä¸²æ ¼å¼
        const checkbox = document.getElementById(`year-${yearStr}`);
        if (checkbox && checkbox.checked) {
            years.push(yearStr); // è¿”å›å­—ç¬¦ä¸²æ ¼å¼ä»¥åŒ¹é…æ•°æ®
        }
    }
    console.log("é€‰æ‹©çš„å¹´ä»½:", years);
    return years;
}

// ä¼šè®®é€‰æ‹©å™¨ç›¸å…³å‡½æ•°
function selectAllConfs() {
    console.log("selectAllConfs called");
    const checkboxes = document.querySelectorAll('#confFilters input[type="checkbox"]');
    console.log("Found checkboxes:", checkboxes.length);
    checkboxes.forEach(cb => {
        cb.checked = true;
        console.log("Checked:", cb.value);
    });
    updateMapVisualization();
}

function clearAllConfs() {
    console.log("clearAllConfs called");
    const checkboxes = document.querySelectorAll('#confFilters input[type="checkbox"]');
    console.log("Found checkboxes:", checkboxes.length);
    checkboxes.forEach(cb => {
        cb.checked = false;
        console.log("Unchecked:", cb.value);
    });
    updateMapVisualization();
}

function selectTopConfs() {
    console.log("selectTopConfs called");
    const topConfs = ['CVPR', 'ICCV', 'ECCV', 'NEURIPS', 'ICML', 'ICLR', 'AAAI', 'IJCAI'];
    const checkboxes = document.querySelectorAll('#confFilters input[type="checkbox"]');
    console.log("Found checkboxes:", checkboxes.length);
    checkboxes.forEach(cb => {
        const shouldCheck = topConfs.includes(cb.value);
        cb.checked = shouldCheck;
        console.log(`${shouldCheck ? 'Checked' : 'Unchecked'}:`, cb.value);
    });
    updateMapVisualization();
}

// åˆå§‹åŒ–æ§åˆ¶é¢æ¿
function initializeControls() {
    // åˆ›å»ºå¹´ä»½é€‰æ‹©å™¨
    createYearSelector();
    
    // ä¼šè®®ç­›é€‰ - å…ˆæ¸…ç©ºç°æœ‰å†…å®¹
    const confFilters = document.querySelector('#confFilters');
    confFilters.innerHTML = '';
    
    console.log("Available conferences:", Array.from(availableConfs));
    
    Array.from(availableConfs).sort().forEach(conf => {
        const div = document.createElement('div');
        div.className = 'filter-checkbox';
        div.innerHTML = `
            <input type="checkbox" id="conf_${conf}" value="${conf}" checked>
            <label for="conf_${conf}">${conf}</label>
        `;
        confFilters.appendChild(div);
        
        div.querySelector('input').addEventListener('change', updateMapVisualization);
    });
    
    console.log("Conference checkboxes created:", confFilters.children.length);
    
    // æœ€å°åˆä½œæ¬¡æ•°æ»‘å—
    const minCollabSlider = document.getElementById('minCollabSlider');
    const minCollabDisplay = document.getElementById('minCollabDisplay');
    
    minCollabSlider.addEventListener('input', function() {
        minCollabDisplay.textContent = this.value;
        updateMapVisualization();
    });
    
    // æ˜¾ç¤ºé€‰é¡¹
    document.getElementById('showLabels').addEventListener('change', updateMapVisualization);
    document.getElementById('showCollaborations').addEventListener('change', updateMapVisualization);
    
    // å…³é—­è¯¦æƒ…é¢æ¿
    document.getElementById('closeDetailButton').addEventListener('click', function() {
        document.getElementById('detailPanel').style.display = 'none';
    });
}

// åˆå§‹åŒ–åº”ç”¨
async function initializeApp() {
    console.log("å¼€å§‹åˆå§‹åŒ–åº”ç”¨...");
    initializeData();
    console.log("æ•°æ®åˆå§‹åŒ–å®Œæˆï¼Œå¯ç”¨ä¼šè®®:", Array.from(availableConfs));
    console.log("å¯ç”¨å¹´ä»½:", Array.from(availableYears));
    
    console.log("å¼€å§‹åˆå§‹åŒ–åœ°å›¾...");
    await initializeMap();
    console.log("åœ°å›¾åˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æ§åˆ¶é¢æ¿...");
    initializeControls();
    console.log("æ§åˆ¶é¢æ¿åˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹æ›´æ–°åœ°å›¾å¯è§†åŒ–...");
    
    // ç¡®ä¿é»˜è®¤è¯­è¨€æ˜¾ç¤ºæ­£ç¡®
    updateLanguageDisplay();
    
    // å»¶è¿Ÿä¸€ç‚¹æ‰§è¡Œæ›´æ–°ï¼Œç¡®ä¿DOMå®Œå…¨å‡†å¤‡å¥½
    setTimeout(() => {
        updateMapVisualization();
        console.log("åº”ç”¨åˆå§‹åŒ–å®Œæˆï¼");
    }, 100);
}

// çª—å£è°ƒæ•´å¤§å°äº‹ä»¶
window.addEventListener('resize', function() {
    const width = window.innerWidth;
    const height = window.innerHeight;
    
    svg.attr("width", width).attr("height", height);
    projection.scale(300).translate([width / 2, height / 2]);  // ä¿æŒå’Œåˆå§‹åŒ–æ—¶ç›¸åŒçš„scaleå€¼
    
    // é‡æ–°ç»˜åˆ¶æ‰€æœ‰è·¯å¾„
    g.selectAll(".countries").attr("d", path);
    updateMapVisualization();
});

// å¹´ä»½æ’­æ”¾åŠŸèƒ½
let isPlaying = false;
let playbackInterval = null;
const PLAYBACK_DELAY = 2000; // 2ç§’é—´éš”

function getAllYears() {
    const years = [];
    for (let year = 2015; year <= 2025; year++) {
        years.push(year);
    }
    return years.sort((a, b) => a - b);
}

function setYearSelection(targetYear) {
    // é¦–å…ˆå–æ¶ˆæ‰€æœ‰å¹´ä»½çš„é€‰æ‹©
    for (let year = 2015; year <= 2025; year++) {
        const checkbox = document.getElementById(`year-${year}`);
        if (checkbox) {
            checkbox.checked = year === targetYear;
        }
    }
    // æ›´æ–°åœ°å›¾æ˜¾ç¤º
    updateMapVisualization();
}

function toggleYearPlayback() {
    const playButton = document.getElementById('playButton');
    
    if (isPlaying) {
        // åœæ­¢æ’­æ”¾
        stopPlayback();
    } else {
        // å¼€å§‹æ’­æ”¾
        startPlayback();
    }
}

function startPlayback() {
    isPlaying = true;
    const playButton = document.getElementById('playButton');
    playButton.textContent = 'â¸ åœæ­¢';
    playButton.classList.add('playing');
    
    const years = getAllYears();
    let currentIndex = 0;
    
    // ç«‹å³æ˜¾ç¤ºç¬¬ä¸€ä¸ªå¹´ä»½
    setYearSelection(years[currentIndex]);
    currentIndex++;
    
    // è®¾ç½®å®šæ—¶å™¨é€ä¸ªæ’­æ”¾å‰©ä½™å¹´ä»½
    playbackInterval = setInterval(() => {
        if (currentIndex >= years.length) {
            // æ’­æ”¾å®Œæˆï¼Œåœæ­¢
            stopPlayback();
            return;
        }
        
        setYearSelection(years[currentIndex]);
        currentIndex++;
    }, PLAYBACK_DELAY);
}

function stopPlayback() {
    isPlaying = false;
    const playButton = document.getElementById('playButton');
    playButton.textContent = 'â–¶ æ’­æ”¾';
    playButton.classList.remove('playing');
    
    if (playbackInterval) {
        clearInterval(playbackInterval);
        playbackInterval = null;
    }
}

// è¯­è¨€åˆ‡æ¢åŠŸèƒ½
let currentLanguage = 'en'; // é»˜è®¤è‹±æ–‡

function toggleLanguage(event) {
    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘é¢æ¿çš„æ‰“å¼€/å…³é—­
    if (event) {
        event.stopPropagation();
    }
    
    currentLanguage = currentLanguage === 'zh' ? 'en' : 'zh';
    updateLanguageDisplay();
    
    // æ›´æ–°æŒ‰é’®æ–‡æœ¬
    const langBtn = document.getElementById('langBtn');
    langBtn.title = currentLanguage === 'zh' ? 'åˆ‡æ¢ä¸­/è‹±æ–‡æ˜¾ç¤º' : 'Toggle Chinese/English Display';
}

function updateLanguageDisplay() {
    // æ›´æ–°æ‰€æœ‰å¸¦æœ‰data-zhå’Œdata-enå±æ€§çš„å…ƒç´ 
    const elements = document.querySelectorAll('[data-zh][data-en]');
    elements.forEach(element => {
        const text = element.getAttribute(`data-${currentLanguage}`);
        if (text) {
            element.textContent = text;
        }
    });
    
    // æ›´æ–°æ§åˆ¶é¢æ¿æ ‡é¢˜
    const panelTitle = document.querySelector('.panel-title');
    if (panelTitle) {
        panelTitle.textContent = currentLanguage === 'zh' ? 'æ§åˆ¶é¢æ¿' : 'Control Panel';
    }
    
    // æ›´æ–°è¿‡æ»¤å™¨æ ‡ç­¾
    updateFilterLabels();
    
    // æ›´æ–°å›¾ä¾‹
    updateLegend();
    
    // å¦‚æœè¯¦æƒ…é¢æ¿å½“å‰æ‰“å¼€ï¼Œé‡æ–°æ¸²æŸ“å…¶å†…å®¹
    const detailPanel = document.getElementById('detailPanel');
    if (detailPanel && detailPanel.style.display === 'block') {
        // å¦‚æœæœ‰å½“å‰æ˜¾ç¤ºçš„æœºæ„ä¿¡æ¯ï¼Œé‡æ–°æ˜¾ç¤º
        const detailTitle = document.getElementById('detailTitle');
        if (detailTitle) {
            // æ£€æŸ¥æ˜¯å¦æœ‰ä¿å­˜çš„åŸå§‹æœºæ„åç§°
            const originalName = detailTitle.getAttribute('data-original-name');
            if (originalName && instituteStats[originalName]) {
                // è¿™æ˜¯ä¸€ä¸ªå…·ä½“çš„æœºæ„ï¼Œé‡æ–°æ˜¾ç¤ºå…¶è¯¦æƒ…
                const instituteData = {
                    name: originalName,
                    papers: instituteStats[originalName].papers,
                    authors: instituteStats[originalName].authorCount,
                    location: getInstituteLocation(originalName)
                };
                showInstituteDetails(instituteData);
            } else if (detailTitle.textContent === 'Unknown Locations' || 
                      detailTitle.textContent === 'æœªçŸ¥ä½ç½®æœºæ„' ||
                      detailTitle.getAttribute('data-unknown-locations') === 'true') {
                // è¿™æ˜¯æœªçŸ¥ä½ç½®çš„æ˜¾ç¤ºï¼Œéœ€è¦é‡æ–°è®¡ç®—å’Œæ˜¾ç¤º
                const filteredPapers = getFilteredPapers();
                computeStats(filteredPapers);
                
                const unknownInstitutes = [];
                Object.keys(instituteStats).forEach(institute => {
                    const location = getInstituteLocation(institute);
                    const stats = instituteStats[institute];
                    
                    if (!location || (location.lat === 0 && location.lon === 0) || location.country === "unknown") {
                        unknownInstitutes.push({
                            name: institute,
                            papers: stats.papers,
                            authors: stats.authorCount,
                            location: location
                        });
                    }
                });
                
                if (unknownInstitutes.length > 0) {
                    showUnknownLocationDetails(unknownInstitutes);
                }
            }
        }
    }
}

function updateFilterLabels() {
    // æ›´æ–°å¹´ä»½é€‰æ‹©æ ‡ç­¾
    const yearLabel = document.querySelector('.year-header .filter-label');
    if (yearLabel) {
        yearLabel.textContent = currentLanguage === 'zh' ? 'å¹´ä»½é€‰æ‹©' : 'Year Selection';
    }
    
    // æ›´æ–°æ’­æ”¾æŒ‰é’®
    const playButton = document.getElementById('playButton');
    if (playButton && !isPlaying) {
        playButton.textContent = currentLanguage === 'zh' ? 'â–¶ æ’­æ”¾' : 'â–¶ Play';
    }
    
    // æ›´æ–°ä¼šè®®æ§åˆ¶æŒ‰é’®
    const confBtns = document.querySelectorAll('.conf-control-btn');
    const confBtnTexts = currentLanguage === 'zh' ? ['å…¨é€‰', 'æ¸…ç©º', 'ä¸»è¦ä¼šè®®'] : ['Select All', 'Clear All', 'Main Conferences'];
    confBtns.forEach((btn, index) => {
        if (confBtnTexts[index]) {
            btn.textContent = confBtnTexts[index];
        }
    });
    
    // æ›´æ–°è¿‡æ»¤å™¨ç»„æ ‡ç­¾ï¼ˆæŒ‰ç‰¹å®šé¡ºåºï¼‰
    const filterGroups = document.querySelectorAll('.filter-group');
    const filterLabelTexts = currentLanguage === 'zh' ? 
        ['å¹´ä»½é€‰æ‹©', 'ä¼šè®®ç­›é€‰', 'æœ€å°åˆä½œæ¬¡æ•°', 'æ˜¾ç¤ºé€‰é¡¹'] : 
        ['Year Selection', 'Conference Filter', 'Min Collaborations', 'Display Options'];
    
    filterGroups.forEach((group, index) => {
        const label = group.querySelector('.filter-label');
        if (label && filterLabelTexts[index]) {
            label.textContent = filterLabelTexts[index];
        }
    });
    
    // åªæ›´æ–°æ˜¾ç¤ºé€‰é¡¹åŒºåŸŸçš„å¤é€‰æ¡†æ ‡ç­¾ï¼ˆä¸åŒ…æ‹¬ä¼šè®®ç­›é€‰åŒºåŸŸçš„ï¼‰
    const displayOptionsGroup = Array.from(document.querySelectorAll('.filter-group')).find(group => {
        const label = group.querySelector('.filter-label');
        return label && (label.textContent.includes('æ˜¾ç¤ºé€‰é¡¹') || label.textContent.includes('Display Options'));
    });
    
    if (displayOptionsGroup) {
        const checkboxLabels = displayOptionsGroup.querySelectorAll('.filter-checkbox label');
        const checkboxTexts = currentLanguage === 'zh' ? 
            ['æ˜¾ç¤ºæœºæ„æ ‡ç­¾', 'æ˜¾ç¤ºåˆä½œè¿çº¿'] : 
            ['Show Institution Labels', 'Show Collaborations'];
        
        checkboxLabels.forEach((label, index) => {
            if (checkboxTexts[index]) {
                label.textContent = checkboxTexts[index];
            }
        });
    }
}

function updateLegend() {
    const legendItems = document.querySelectorAll('#legend .legend-item span');
    const legendTexts = currentLanguage === 'zh' ? 
        ['æœºæ„ä½ç½®', 'æœªçŸ¥ä½ç½®æœºæ„', 'åˆä½œå…³ç³»'] : 
        ['Institution Location', 'Unknown Location', 'Collaboration'];
    
    legendItems.forEach((item, index) => {
        if (legendTexts[index]) {
            item.textContent = legendTexts[index];
        }
    });
}

// ä¿¡æ¯æ¨¡æ€æ¡†åŠŸèƒ½
function showInfoModal(event) {
    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘é¢æ¿çš„æ‰“å¼€/å…³é—­
    if (event) {
        event.stopPropagation();
    }
    
    const modal = document.getElementById('infoModal');
    modal.style.display = 'block';
    
    // é˜²æ­¢é¡µé¢æ»šåŠ¨
    document.body.style.overflow = 'hidden';
}

function closeInfoModal() {
    const modal = document.getElementById('infoModal');
    modal.style.display = 'none';
    
    // æ¢å¤é¡µé¢æ»šåŠ¨
    document.body.style.overflow = 'auto';
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
window.addEventListener('click', function(event) {
    const modal = document.getElementById('infoModal');
    if (event.target === modal) {
        closeInfoModal();
    }
});

// æŒ‰ESCé”®å…³é—­æ¨¡æ€æ¡†
window.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeInfoModal();
    }
});

// å¯åŠ¨åº”ç”¨
initializeApp();

</script>
</body>
</html>