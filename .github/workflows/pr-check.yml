name: Pull Request Check
run-name: Checking PR for compilation errors 🔍

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

# Minimal permissions for external contributors
permissions:
  contents: read

jobs:
  check-compilation:
    runs-on: ubuntu-latest
    outputs:
      success: ${{ steps.compile.outputs.success }}
      pr_number: ${{ github.event.number }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Run compile_map.py
        id: compile
        run: |
          echo "🔄 Running compile_map.py..."
          if python compile_map.py; then
            echo "✅ Compilation successful!"
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "❌ Compilation failed!"
            echo "success=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
      - name: Check if result files were generated
        if: steps.compile.outputs.success == 'true'
        run: |
          if [ -f "result_map.html" ] && [ -f "result_bar_graph.html" ]; then
            echo "✅ Both result files were successfully generated"
            echo "📊 Map file size: $(du -h result_map.html | cut -f1)"
            echo "📊 Bar chart file size: $(du -h result_bar_graph.html | cut -f1)"
          else
            echo "⚠️ One or more result files were not generated"
            exit 1
          fi

      - name: Save PR info for comment workflow
        run: |
          mkdir -p ./pr-info
          echo "${{ github.event.number }}" > ./pr-info/pr_number
          echo "${{ steps.compile.outputs.success }}" > ./pr-info/success
          echo "${{ github.run_id }}" > ./pr-info/run_id
          
      - name: Upload PR info
        uses: actions/upload-artifact@v4
        with:
          name: pr-info
          path: ./pr-info/
          retention-days: 1